-content_for('turolinks-cache') { 'no-cache' }

= form_for(word, local: true, class: 'needs-validation', novalidate: true) do |f|
  - if word.errors.any?
    .alert.alert-danger.alert-dismissible.fade.show role="alert"
      button.btn-close type="button" data-bs-dismiss="alert" aria-label="Close"
      h5.alert-heading
        = pluralize(word.errors.count, "error")
        |  prohibited this word from being saved:
      ul.mb-0
        - word.errors.full_messages.each do |message|
          li = message

  .px-0
    .row
      .col-12
        - unless template_list.empty?
          .mb-3
            = label_tag :template, "Template", class: 'form-label'
            = select_tag :template, options_for_select(template_list), {id: 'template-selector', class: 'form-select', include_blank: 'Choose a template...' }
            .form-text Select a template to start with predefined content.

        .mb-3
          = f.label :title, class: 'form-label'
          = f.text_field :title, class: 'form-control form-control-lg', placeholder: 'Enter the title for your word', required: true
          .invalid-feedback Please provide a title.

        - if word.persisted?
          .mb-3
            = button_tag type: 'button', class: 'btn btn-outline-primary', id: 'ai-edit-btn', data: { word_id: word.id } do
              | ğŸ¤– AIã‚¨ãƒ‡ã‚£ãƒƒãƒˆ
            = button_tag type: 'button', class: 'btn btn-outline-secondary btn-sm ms-2', id: 'test-api-btn' do
              | ãƒ†ã‚¹ãƒˆ
            .form-text Generate content using AI based on the word title. Click "ãƒ†ã‚¹ãƒˆ" to check API connection.

javascript:
  document.addEventListener('DOMContentLoaded', function() {
    const aiEditBtn = document.getElementById('ai-edit-btn');
    const testApiBtn = document.getElementById('test-api-btn');
    
    if (testApiBtn) {
      testApiBtn.addEventListener('click', function() {
        const wordId = aiEditBtn ? aiEditBtn.dataset.wordId : 1;
        
        const originalText = this.innerHTML;
        this.disabled = true;
        this.innerHTML = 'ğŸ”„ ãƒ†ã‚¹ãƒˆä¸­...';
        
        fetch(`/${wordId}/ai_edit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showMessage('APIæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼', 'success');
          } else {
            showMessage(`APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${data.error}`, 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        })
        .finally(() => {
          this.disabled = false;
          this.innerHTML = originalText;
        });
      });
    }
    
    if (aiEditBtn) {
      aiEditBtn.addEventListener('click', function() {
        const wordId = this.dataset.wordId;
        const trixEditor = document.querySelector('trix-editor');
        
        if (!trixEditor) {
          alert('ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«ã™ã‚‹
        const originalText = this.innerHTML;
        this.disabled = true;
        this.innerHTML = 'ğŸ”„ ç”Ÿæˆä¸­...';
        
        // Ajax ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        fetch(`/${wordId}/ai_edit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Trixã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¨­å®š
            trixEditor.editor.setDocument(Trix.Document.fromString(data.content));
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            showMessage('AIã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
          } else {
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            showMessage(`ã‚¨ãƒ©ãƒ¼: ${data.error}`, 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        })
        .finally(() => {
          // ãƒœã‚¿ãƒ³ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
          this.disabled = false;
          this.innerHTML = originalText;
        });
      });
    }
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function showMessage(message, type) {
      // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å‰Šé™¤
      const existingMessage = document.querySelector('.ai-edit-message');
      if (existingMessage) {
        existingMessage.remove();
      }
      
      // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
      const messageDiv = document.createElement('div');
      messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show ai-edit-message`;
      messageDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã®ä¸Šéƒ¨ã«æŒ¿å…¥
      const form = document.querySelector('form');
      if (form) {
        form.insertAdjacentElement('beforebegin', messageDiv);
        
        // 3ç§’å¾Œã«è‡ªå‹•çš„ã«å‰Šé™¤
        setTimeout(() => {
          if (messageDiv && messageDiv.parentNode) {
            messageDiv.remove();
          }
        }, 3000);
      }
    }
  });

        .mb-3
          = f.label :tag_list, "Tags", class: 'form-label'
          = f.text_field :tag_list, value: word.tag_list.to_s, class: 'form-control', placeholder: 'Add tags separated by commas'
          .form-text Use tags to categorize and organize your content.

        .mb-4
          = f.label :body, "Content", class: 'form-label'
          = f.rich_text_area :body, class: 'form-control rich-text-editor'
          .form-text Use the toolbar above to format your content with rich text.

        .d-flex.gap-2.justify-content-end.align-items-center
          = link_to 'Cancel', words_path, class: 'btn btn-outline-secondary'
          - if word.persisted? && word.id != 1
            = link_to 'Delete', word, method: :delete, data: { turbo_method: :delete, turbo_confirm: 'Are you sure you want to delete this word? This action cannot be undone.' }, class: 'btn btn-danger'
          = f.submit word.persisted? ? 'Update Word' : 'Create Word', class: 'btn btn-primary px-4'
